{% extends 'base.html.twig' %}

{% set is_pdf = pdf_export is defined and pdf_export %}

{% block title %}{{ 'simple_audit.title'|trans({'%name%': account.first_name ~ ' ' ~ account.last_name}) }}{% endblock %}

{% block body_class %}{% if is_pdf %}simple-audit--pdf{% endif %}{% endblock %}

{% block header %}{% if not is_pdf %}{{ parent() }}{% endif %}{% endblock %}

{% block footer %}{% if not is_pdf %}{{ parent() }}{% endif %}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .simple-audit {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .simple-audit__header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 1rem;
            align-items: center;
        }
        .simple-audit__brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .simple-audit__brand img {
            height: 48px;
        }
        .simple-audit__stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }
        .simple-audit__stat {
            background: rgba(37, 99, 235, 0.08);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }
        .simple-audit__stat strong {
            display: block;
            font-size: 1.35rem;
        }
        .simple-audit__grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
        .simple-audit table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.75rem;
            font-size: 0.9rem;
        }
        .simple-audit th,
        .simple-audit td {
            padding: 0.5rem 0.75rem;
            border: 1px solid rgba(148, 163, 184, 0.45);
            text-align: left;
        }
        .simple-audit thead th {
            background: rgba(148, 163, 184, 0.15);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        .simple-audit__cta {
            background: rgba(14, 165, 233, 0.08);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .simple-audit__footer {
            margin-top: 1rem;
            font-size: 0.85rem;
            color: #64748b;
            text-align: right;
        }
        @media print {
            body.simple-audit--pdf {
                background: #fff;
            }
            .simple-audit__stat {
                background: #eef2ff;
            }
            .simple-audit__cta {
                background: #f8fafc;
            }
        }
    </style>
{% endblock %}

{% block body %}
    <article class="card simple-audit">
        <header class="simple-audit__header">
            <div class="simple-audit__brand">
                <img src="{{ absolute_url(asset('images/logo-new.png')) }}" alt="{{ 'app.name'|trans }} logo">
                <div>
                    <h1 class="page-title">{{ 'simple_audit.summary.headline'|trans }}</h1>
                    <p class="muted">{{ 'simple_audit.summary.client_label'|trans }}: {{ account.first_name }} {{ account.last_name }}</p>
                </div>
            </div>
            {% if not is_pdf and report_file is defined %}
                <a class="button button--primary" href="{{ path('app_simple_audit_pdf', { file: report_file }) }}">{{ 'simple_audit.download'|trans }}</a>
            {% endif %}
        </header>

        <section class="simple-audit__stats" aria-label="Score summary">
            <div class="simple-audit__stat">
                <span>{{ 'simple_audit.stats.equifax'|trans }}</span>
                <strong>{{ client_data.equifax.credit_score }}</strong>
            </div>
            <div class="simple-audit__stat">
                <span>{{ 'simple_audit.stats.transunion'|trans }}</span>
                <strong>{{ client_data.trans_union.credit_score }}</strong>
            </div>
            <div class="simple-audit__stat">
                <span>{{ 'simple_audit.stats.experian'|trans }}</span>
                <strong>{{ client_data.experian.credit_score }}</strong>
            </div>
            <div class="simple-audit__stat">
                <span>{{ 'simple_audit.stats.report_date'|trans }}</span>
                <strong>{{ client_data.trans_union.report_data }}</strong>
            </div>
        </section>

        <div class="simple-audit__grid">
            <section>
                <h2>{{ 'simple_audit.sections.negative'|trans }}</h2>
                <p class="muted">Total derogatory items: <strong>{{ derogatory_accounts.total }}</strong></p>
                {% if derogatory_accounts.accounts|length > 0 %}
                    <table>
                        <thead>
                            <tr>
                                <th scope="col">{{ 'simple_audit.table.account'|trans }}</th>
                                <th scope="col">{{ 'simple_audit.table.issue'|trans }}</th>
                                <th scope="col">{{ 'simple_audit.table.dates'|trans }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in derogatory_accounts.accounts|slice(0, 8) %}
                                <tr>
                                    <td>{{ item.account }}</td>
                                    <td>{{ item.unique_status }}</td>
                                    <td>{{ item.trans_union_account_date }} / {{ item.experian_account_date }} / {{ item.equifax_account_date }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="muted">{{ 'simple_audit.tips.negative_none'|trans }}</p>
                {% endif %}
            </section>

            <section>
                <h2>{{ 'simple_audit.sections.utilization'|trans }}</h2>
                <table>
                    <tbody>
                        <tr>
                            <th scope="row">Total revolving limit</th>
                            <td>${{ credit_info.total_limit }}</td>
                        </tr>
                        <tr>
                            <th scope="row">Total revolving balance</th>
                            <td>${{ credit_info.total_balance }}</td>
                        </tr>
                        <tr>
                            <th scope="row">Overall utilization</th>
                            <td>{{ credit_info.total_percent }}%</td>
                        </tr>
                        <tr>
                            <th scope="row">Equifax</th>
                            <td>{{ credit_info.equifax_percent }}%</td>
                        </tr>
                        <tr>
                            <th scope="row">TransUnion</th>
                            <td>{{ credit_info.trans_union_percent }}%</td>
                        </tr>
                        <tr>
                            <th scope="row">Experian</th>
                            <td>{{ credit_info.experian_percent }}%</td>
                        </tr>
                    </tbody>
                </table>
                <p class="muted">{{ 'simple_audit.tips.utilization'|trans }}</p>
            </section>
        </div>

        <div class="simple-audit__grid">
            <section>
                <h2>{{ 'simple_audit.sections.inquiries'|trans }}</h2>
                <p class="muted">Total inquiries (24 months): <strong>{{ inquiry_accounts.total }}</strong></p>
                {% if inquiry_accounts.total > 0 %}
                    <table>
                        <thead>
                            <tr>
                                <th scope="col">Business</th>
                                <th scope="col">Type</th>
                                <th scope="col">Date</th>
                                <th scope="col">Bureau</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in inquiry_accounts.accounts|slice(0, 8) %}
                                <tr>
                                    {% for value in row %}
                                        <td>{{ value }}</td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="muted">{{ 'simple_audit.tips.inquiries_none'|trans }}</p>
                {% endif %}
            </section>

            <section>
                <h2>{{ 'simple_audit.sections.public'|trans }}</h2>
                <p class="muted">Total public records: <strong>{{ public_records.total }}</strong></p>
                {% if public_records.records|length > 0 %}
                    <table>
                        <thead>
                            <tr>
                                <th scope="col">Type</th>
                                <th scope="col">Status</th>
                                <th scope="col">Filed (TU/EX/EQ)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rec in public_records.records|slice(0, 6) %}
                                <tr>
                                    <td>{{ rec.type }}</td>
                                    <td>{{ rec.status }}</td>
                                    <td>{{ rec.trans_union_files }} / {{ rec.experian_filed }} / {{ rec.equifax_filed }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="muted">{{ 'simple_audit.tips.public_none'|trans }}</p>
                {% endif %}
            </section>
        </div>

        <div class="simple-audit__grid">
            <section>
                <h2>{{ 'simple_audit.sections.workflow'|trans }}</h2>
                {% if dispute_workflow is defined %}
                    <p class="muted">Case status: <strong>{{ dispute_workflow.case.status|title }}</strong></p>
                    <p>Tasks complete: <strong>{{ dispute_workflow.case.progress.completed }}/{{ dispute_workflow.case.progress.total }}</strong> ({{ dispute_workflow.case.progress.percent }}%).</p>
                    <p>Client-facing tasks open: <strong>{{ dispute_workflow.case.progress.open_client_tasks }}</strong></p>
                    {% if dispute_workflow.recommended_items|length > 0 %}
                        {% set targetNames = [] %}
                        {% for item in dispute_workflow.recommended_items|slice(0,3) %}
                            {% set targetNames = targetNames|merge([item.account]) %}
                        {% endfor %}
                        <p class="muted">Top targets: {{ targetNames|join(', ') }}</p>
                    {% endif %}
                    {% if not is_pdf %}
                        <p><a class="button button--ghost" href="{{ path('app_dispute_dashboard', { aid: account.aid }) }}">{{ 'accounts.view.audit_link'|trans }}</a></p>
                    {% endif %}
                {% else %}
                    <p class="muted">{{ 'simple_audit.tips.workflow_none'|trans }}</p>
                {% endif %}
            </section>

            <section>
                <h2>{{ 'simple_audit.sections.notes'|trans }}</h2>
                <ol>
                    {% for key in ['one', 'two', 'three', 'four'] %}
                        <li>{{ ('simple_audit.notes.' ~ key)|trans }}</li>
                    {% endfor %}
                </ol>
                <div class="simple-audit__cta">
                    {{ 'simple_audit.tips.cta'|trans }}
                    {% if not is_pdf and report_file is defined %}
                        <a href="{{ path('app_parse_html', { file: report_file }) }}" target="_blank" rel="noopener">{{ 'simple_audit.tips.cta_link'|trans }}</a>.
                    {% endif %}
                </div>
            </section>
        </div>

        <footer class="simple-audit__footer">
            Generated on {{ 'now'|date('Y-m-d H:i') }}.
        </footer>
    </article>
{% endblock %}
